<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Painel do Professor</title>

  <!-- Ícones Remix e CSS -->
  <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
  <link rel="stylesheet" href="professor.css" />
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
  <!-- ===== BARRA SUPERIOR ===== -->
  <header class="barra-superior">
    <div class="logo">
      <i class="ri-graduation-cap-line"></i>
      <span>Painel do Professor</span>
    </div>
    <nav class="menu-topo">
      <ul>
        <li class="ativo" onclick="mostrar('dashboard')"><i class="ri-dashboard-line"></i> Dashboard</li>
        <li onclick="mostrar('disciplinas')"><i class="ri-book-open-line"></i> Disciplinas</li>
        <li onclick="mostrar('turmas')"><i class="ri-group-line"></i> Turmas</li>
        <li onclick="mostrar('notas')"><i class="ri-file-list-3-line"></i> Lançar Notas</li>
        <li onclick="mostrar('relatorios')"><i class="ri-bar-chart-2-line"></i> Relatórios</li>
        <li onclick="mostrar('calendario')"><i class="ri-calendar-line"></i> Calendário</li>
        <li onclick="mostrar('perfil')"><i class="ri-user-settings-line"></i> Perfil</li>
      </ul>
    </nav>
    <button class="logout" onclick="logout()">
      <i class="ri-logout-box-line"></i> Sair
    </button>
  </header>

  <!-- ===== CONTEÚDO PRINCIPAL ===== -->
  <main class="conteudo-principal">
    <section class="cabecalho">
      <h1>Bem-vindo(a), <span id="nomeProfessor">Prof. Ana Souza</span>!</h1>
      <p>Gerencie suas disciplinas, turmas e notas com praticidade.</p>
    </section>

    <section id="dashboard" class="dashboard-professor">
      <div class="card" onclick="mostrar('notas')">
        <i class="ri-file-list-3-line"></i>
        <h2>Lançar Notas</h2>
        <p>Registre e atualize as notas dos alunos.</p>
      </div>

      <div class="card" onclick="mostrar('turmas')">
        <i class="ri-group-line"></i>
        <h2>Gerenciar Turmas</h2>
        <p>Visualize e organize suas turmas.</p>
      </div>

      <div class="card" onclick="mostrar('disciplinas')">
        <i class="ri-book-open-line"></i>
        <h2>Minhas Disciplinas</h2>
        <p>Acesse e edite suas disciplinas ativas.</p>
      </div>

      <div class="card" onclick="mostrar('relatorios')">
        <i class="ri-bar-chart-2-line"></i>
        <h2>Relatórios</h2>
        <p>Veja o desempenho dos alunos por turma.</p>
      </div>

      <div class="card" onclick="mostrar('calendario')">
        <i class="ri-calendar-line"></i>
        <h2>Calendário</h2>
        <p>Visualize datas de provas e eventos acadêmicos.</p>
      </div>

      <div class="card" onclick="mostrar('perfil')">
        <i class="ri-user-settings-line"></i>
        <h2>Perfil</h2>
        <p>Atualize suas informações pessoais e senha.</p>
      </div>
    </section>

    <!-- ===== PÁGINAS ===== -->
<section id="disciplinas" class="pagina oculto">
  <h2>Minhas Disciplinas</h2>

  <div class="disciplinas-header">
    <button id="btnAddDisciplina">+ Adicionar Disciplina</button>
  </div>

  <table class="tabela-relatorio" id="tabelaDisciplinas">
    <thead>
      <tr>
        <th>Disciplina</th>
        <th>Turmas Associadas</th>
        <th>Ações</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</section>

<section id="turmas" class="pagina oculto">
  <h2>Gerenciar Turmas</h2>

  <div class="turmas-container">
    <table class="tabela-turmas">
      <thead>
        <tr>
          <th>Nome da Turma</th>
          <th>Disciplina</th>
          <th>Ações</th>
        </tr>
      </thead>
      <tbody id="listaTurmas"></tbody>
    </table>
  </div>
</section>

<!-- ✅ NOVA SEÇÃO DE LANÇAMENTO DE NOTAS -->
<section id="notas" class="pagina oculto">
  <h2>Lançar Notas</h2>

  <div class="form-lancar-notas">

    <label for="disciplinaSelect">Disciplina:</label>
    <select id="disciplinaSelect">
      <option value="">Selecione...</option>
    </select>

    <label for="turmaSelect">Turma:</label>
    <select id="turmaSelect">
      <option value="">Selecione uma disciplina primeiro...</option>
    </select>

    <div id="listaAlunos" class="lista-alunos oculto">
      <h3>Alunos da Turma</h3>
      <table>
        <thead>
  <tr>
    <th>Aluno</th>
    <th>Disciplina</th>
    <th>Turma</th>
    <th>Nota</th>
  </tr>
</thead>
        <tbody id="alunosTabela"></tbody>
      </table>

      <button onclick="salvarNotas()" class="btn-salvar">Salvar Notas</button>
    </div>

  </div>
</section>

<section id="relatorios" class="pagina oculto">
  <h2>Relatórios de Desempenho</h2>

  <div class="filtros-relatorio">
    <label>Disciplina:</label>
    <select id="filtroDisciplina">
      <option value="">Todas</option>
    </select>

    <label>Turma:</label>
    <select id="filtroTurma">
      <option value="">Todas</option>
    </select>
  </div>

  <div class="relatorio-box">
    <table class="tabela-relatorio">
  <thead>
    <tr>
      <th>Aluno</th>
      <th>Disciplina</th>
      <th>Turma</th>
      <th>Nota</th>
    </tr>
  </thead>
  <tbody id="tabelaRelatorio"></tbody>
</table>

    <div class="media-turma">
      Média da Turma: <span id="mediaValor">-</span>
    </div>

    <div class="export-buttons">
      <button onclick="exportarPDF()">Exportar PDF</button>
      <button onclick="exportarExcel()">Exportar Excel</button>
    </div>
  </div>
</section>

<section id="calendario" class="pagina oculto">
  <h2>Calendário Acadêmico</h2>

  <div class="calendario-container">
    <div class="calendario-header">
      <button id="mesAnterior"><i class="ri-arrow-left-s-line"></i></button>
      <h3 id="mesAtual"></h3>
      <button id="mesProximo"><i class="ri-arrow-right-s-line"></i></button>
    </div>

    <table class="calendario-tabela">
      <thead>
        <tr>
          <th>Dom</th><th>Seg</th><th>Ter</th><th>Qua</th><th>Qui</th><th>Sex</th><th>Sáb</th>
        </tr>
      </thead>
      <tbody id="diasCalendario"></tbody>
    </table>
  </div>
</section>

<section id="perfil" class="pagina oculto">
  <div class="perfil-container">

    <div class="perfil-avatar">
      <img id="fotoPerfil" src="imagens/Foto_de_Perfil_Pedro.png" alt="Foto do Professor">
      <button id="btnTrocarFoto">Trocar Foto</button>
      <input type="file" id="inputFoto" accept="image/*" class="oculto">
    </div>

    <div class="perfil-info">
      <h2>Perfil do Professor</h2>

      <label>Nome:</label>
      <input type="text" id="perfilNome" disabled>

      <label>Email:</label>
      <input type="text" id="perfilEmail" disabled>

      <div class="perfil-botoes">
        <button id="btnEditarPerfil">Editar</button>
        <button id="btnSalvarPerfil" class="oculto">Salvar</button>
      </div>

      <hr>

      <button id="btnAlterarSenha" class="btn-senha">Alterar Senha</button>
    </div>

  </div>
</section>


  </main>

<script>
document.addEventListener("DOMContentLoaded", () => {

  /* ===== INICIALIZAÇÃO NOME ===== */
  const usuario = JSON.parse(localStorage.getItem("usuarioLogado"));
  document.getElementById("nomeProfessor").textContent = usuario?.nome || "Professor";

  /* ===== DADOS PADRÃO ===== */
  const disciplinasPadrao = {
    "Matemática": ["Turma A", "Turma B"],
    "Português": ["Turma A"],
    "História": ["Turma C"]
  };

  const alunosPorTurma = {
    "Turma A": ["Lucas", "Mariana", "João", "Ana Paula"],
    "Turma B": ["Carlos", "Júlia", "Miguel"],
    "Turma C": ["Rafaela", "Tiago", "Eduardo"]
  };

  /* ===== CARREGA / CRIA disciplinas NO localStorage SE NÃO EXISTIR ===== */
  let disciplinas = JSON.parse(localStorage.getItem("disciplinas"));
  if (!disciplinas || Object.keys(disciplinas).length === 0) {
    disciplinas = disciplinasPadrao;
    localStorage.setItem("disciplinas", JSON.stringify(disciplinas));
  }

  /* ===== ELEMENTOS ===== */
  const disciplinaSelect = document.getElementById("disciplinaSelect");
  const turmaSelect = document.getElementById("turmaSelect");
  const listaAlunosDiv = document.getElementById("listaAlunos");
  const alunosTabela = document.getElementById("alunosTabela");

  const filtroDisciplina = document.getElementById("filtroDisciplina");
  const filtroTurma = document.getElementById("filtroTurma");
  const tabelaRelatorio = document.getElementById("tabelaRelatorio");
  const mediaValor = document.getElementById("mediaValor");

  /* ===== FUNÇÕES ===== */
  function initDisciplinaSelect() {
    if (!disciplinaSelect) return;
    disciplinaSelect.innerHTML = `<option value="">Selecione...</option>`;
    Object.keys(disciplinas).forEach(nome => {
      disciplinaSelect.innerHTML += `<option value="${nome}">${nome}</option>`;
    });
  }

  function initFiltrosRelatorio() {
    if (!filtroDisciplina || !filtroTurma) return;
    filtroDisciplina.innerHTML = '<option value="">Todas</option>';
    filtroTurma.innerHTML = '<option value="">Todas</option>';
    Object.keys(disciplinas).forEach(d => filtroDisciplina.innerHTML += `<option value="${d}">${d}</option>`);
    filtroDisciplina.onchange = () => {
      filtroTurma.innerHTML = '<option value="">Todas</option>';
      (disciplinas[filtroDisciplina.value] || []).forEach(t => filtroTurma.innerHTML += `<option value="${t}">${t}</option>`);
      carregarRelatorio();
    };
    filtroTurma.onchange = carregarRelatorio;
  }

  function carregarRelatorio() {
    if (!tabelaRelatorio) return;
    const filtroD = filtroDisciplina?.value || "";
    const filtroT = filtroTurma?.value || "";
    const dados = JSON.parse(localStorage.getItem("notasCompleto")) || [];
    const filtrados = dados.filter(n =>
      (!filtroD || n.disciplina === filtroD) &&
      (!filtroT || n.turma === filtroT)
    );

    tabelaRelatorio.innerHTML = filtrados.map(d =>
      `<tr><td>${d.aluno}</td><td>${d.disciplina}</td><td>${d.turma}</td><td>${d.nota}</td></tr>`
    ).join("");

    const numeros = filtrados.map(d => Number(d.nota)).filter(n => !isNaN(n));
    mediaValor.textContent = numeros.length ? (numeros.reduce((a,b)=>a+b)/numeros.length).toFixed(2) : "-";
  }

  function salvarNotas() {
    const disciplina = disciplinaSelect.value;
    const turma = turmaSelect.value;
    if (!disciplina || !turma) return alert("Selecione disciplina e turma.");

    const linhas = alunosTabela.querySelectorAll("tr");
    let dados = JSON.parse(localStorage.getItem("notasCompleto")) || [];

    linhas.forEach(linha => {
      const aluno = linha.children[0].textContent.trim();
      const notaRaw = linha.children[1].children[0].value;
      const nota = notaRaw === "" ? "-" : notaRaw;

      const idx = dados.findIndex(r =>
        r.aluno === aluno && r.disciplina === disciplina && r.turma === turma
      );
      const registro = { aluno, disciplina, turma, nota };
      if (idx === -1) dados.push(registro);
      else dados[idx] = registro;
    });

    localStorage.setItem("notasCompleto", JSON.stringify(dados));
    alert("✅ Notas salvas com sucesso!");
    // atualiza relatório caso esteja visível
    carregarRelatorio();
  }

  /* ===== EVENTOS select ===== */
  if (disciplinaSelect) {
    disciplinaSelect.onchange = () => {
      turmaSelect.innerHTML = '<option value="">Selecione...</option>';
      listaAlunosDiv.classList.add("oculto");
      alunosTabela.innerHTML = "";
      const sel = disciplinaSelect.value;
      if (sel && disciplinas[sel]) {
        disciplinas[sel].forEach(t => turmaSelect.innerHTML += `<option value="${t}">${t}</option>`);
      }
    };
  }

  if (turmaSelect) {
    turmaSelect.onchange = () => {
      alunosTabela.innerHTML = "";
      if (!turmaSelect.value) return;
      (alunosPorTurma[turmaSelect.value] || []).forEach(aluno => {
        alunosTabela.innerHTML += `
          <tr>
            <td>${aluno}</td>
            <td><input type="number" min="0" max="10" step="0.1" placeholder="ex: 8.5"></td>
          </tr>`;
      });
      listaAlunosDiv.classList.remove("oculto");
    };
  }

  /* ===== EXPORT / PDF / EXCEL (simples) ===== */
  function exportarPDF() { window.print(); }
  function exportarExcel() { alert("Exportação para Excel configurada anteriormente."); }

  /* ===== NAVEGAÇÃO SPA ===== */
  function mostrarPagina(pagina) {
    // remove ativo do menu
    document.querySelectorAll(".menu-topo ul li").forEach(li => li.classList.remove("ativo"));
    // marca ativo
    const item = Array.from(document.querySelectorAll(".menu-topo ul li")).find(li => li.getAttribute("onclick")?.includes(`'${pagina}'`));
    if (item) item.classList.add("ativo");

    // esconde todas páginas e dashboard
    document.querySelectorAll(".pagina").forEach(sec => sec.classList.add("oculto"));
    document.getElementById("dashboard")?.classList.add("oculto");

    // mostra a solicitada
    const target = document.getElementById(pagina);
    if (target) {
      target.classList.remove("oculto");
    }

    // se abrir relatórios carrega filtros
    if (pagina === "relatorios") {
      initFiltrosRelatorio();
      carregarRelatorio();
    }
  }

  // expõe as funções globais usadas pelo HTML
  window.salvarNotas = salvarNotas;
  window.exportarPDF = exportarPDF;
  window.exportarExcel = exportarExcel;
  window.mostrar = mostrarPagina;

  /* ===== PERFIL (simples) ===== */
  function carregarPerfil() {
    const user = JSON.parse(localStorage.getItem("usuarioLogado")) || { nome: "Professor", email: "" };
    const perfilNome = document.getElementById("perfilNome");
    const perfilEmail = document.getElementById("perfilEmail");
    const fotoPerfil = document.getElementById("fotoPerfil");
    if (perfilNome) perfilNome.value = user.nome || "";
    if (perfilEmail) perfilEmail.value = user.email || "";
    if (fotoPerfil && user.foto) fotoPerfil.src = user.foto;
  }

  window.carregarPerfil = carregarPerfil;

  /* ===== LOGOUT ===== */
  window.logout = function() {
    localStorage.removeItem("usuarioLogado");
    // se quiser limpar tudo: localStorage.clear();
    window.location.href = "index.html";
  };

  /* ===== Inicializações ===== */
  initDisciplinaSelect();
  initFiltrosRelatorio();
  carregarPerfil();

  // por padrão mostra dashboard ao abrir a página
  mostrarPagina("dashboard");

  // conecta botões do perfil se existirem (controle de edição)
  const btnEditarPerfil = document.getElementById("btnEditarPerfil");
  const btnSalvarPerfil = document.getElementById("btnSalvarPerfil");
  const btnAlterarSenha = document.getElementById("btnAlterarSenha");
  const btnTrocarFoto = document.getElementById("btnTrocarFoto");
  const inputFoto = document.getElementById("inputFoto");
  const perfilNomeEl = document.getElementById("perfilNome");
  const perfilEmailEl = document.getElementById("perfilEmail");
  const fotoPerfilEl = document.getElementById("fotoPerfil");

  if (btnEditarPerfil && btnSalvarPerfil && perfilNomeEl && perfilEmailEl) {
    btnEditarPerfil.onclick = () => {
      perfilNomeEl.disabled = perfilEmailEl.disabled = false;
      btnEditarPerfil.classList.add("oculto");
      btnSalvarPerfil.classList.remove("oculto");
    };
    btnSalvarPerfil.onclick = () => {
      let user = JSON.parse(localStorage.getItem("usuarioLogado")) || {};
      user.nome = perfilNomeEl.value;
      user.email = perfilEmailEl.value;
      localStorage.setItem("usuarioLogado", JSON.stringify(user));
      carregarPerfil();
      btnSalvarPerfil.classList.add("oculto");
      btnEditarPerfil.classList.remove("oculto");
    };
  }

  if (btnAlterarSenha) {
    btnAlterarSenha.onclick = () => {
      const nova = prompt("Digite a nova senha:");
      if (!nova) return;
      let user = JSON.parse(localStorage.getItem("usuarioLogado")) || {};
      user.senha = nova;
      localStorage.setItem("usuarioLogado", JSON.stringify(user));
      alert("Senha atualizada!");
    };
  }

  if (btnTrocarFoto && inputFoto && fotoPerfilEl) {
    btnTrocarFoto.onclick = () => inputFoto.click();
    inputFoto.onchange = (e) => {
      const arquivo = e.target.files[0];
      if (!arquivo) return;
      const reader = new FileReader();
      reader.onloadend = () => {
        fotoPerfilEl.src = reader.result;
        let user = JSON.parse(localStorage.getItem("usuarioLogado")) || {};
        user.foto = reader.result;
        localStorage.setItem("usuarioLogado", JSON.stringify(user));
      };
      reader.readAsDataURL(arquivo);
    };
  }

  // expõe salvarNotas no escopo global (já feito acima)
  window.salvarNotas = salvarNotas;

}); // DOMContentLoaded end

document.addEventListener("DOMContentLoaded", function () {
  const mesAtualLabel = document.getElementById("mesAtual");
  const diasTabela = document.getElementById("diasCalendario");
  const btnAnterior = document.getElementById("mesAnterior");
  const btnProximo = document.getElementById("mesProximo");

  let data = new Date();

  function renderizarCalendario() {
    diasTabela.innerHTML = "";

    let ano = data.getFullYear();
    let mes = data.getMonth();

    // Mostra mês e ano
    mesAtualLabel.textContent = data.toLocaleDateString("pt-BR", {
      month: "long",
      year: "numeric"
    });

    let primeiroDiaSemana = new Date(ano, mes, 1).getDay();
    let ultimoDiaMes = new Date(ano, mes + 1, 0).getDate();

    let linha = document.createElement("tr");

    // Preencher espaços antes do dia 1
    for (let i = 0; i < primeiroDiaSemana; i++) {
      linha.appendChild(document.createElement("td"));
    }

    // Preencher dias do mês
    for (let dia = 1; dia <= ultimoDiaMes; dia++) {
      if (linha.children.length === 7) {
        diasTabela.appendChild(linha);
        linha = document.createElement("tr");
      }

      let td = document.createElement("td");
      td.textContent = dia;

      // Destacar o dia atual
      let hoje = new Date();
      if (
        dia === hoje.getDate() &&
        mes === hoje.getMonth() &&
        ano === hoje.getFullYear()
      ) {
        td.classList.add("dia-hoje");
      }

      linha.appendChild(td);
    }

    diasTabela.appendChild(linha);
  }

  // Botões navegação
  btnAnterior.addEventListener("click", function () {
    data.setMonth(data.getMonth() - 1);
    renderizarCalendario();
  });

  btnProximo.addEventListener("click", function () {
    data.setMonth(data.getMonth() + 1);
    renderizarCalendario();
  });

  renderizarCalendario();
});

function carregarTurmasProfessor() {
  const professorLogado = JSON.parse(localStorage.getItem("professorLogado"));
  const turmas = JSON.parse(localStorage.getItem("turmas")) || [];
  const disciplinas = JSON.parse(localStorage.getItem("disciplinas")) || [];

  const lista = document.getElementById("listaTurmas");
  lista.innerHTML = "";

  const turmasProfessor = turmas.filter(t => t.idProfessor === professorLogado.id);

  turmasProfessor.forEach(turma => {
    const disciplina = disciplinas.find(d => d.id === turma.idDisciplina);

    lista.innerHTML += `
      <tr>
        <td>${turma.nome}</td>
        <td>${disciplina ? disciplina.nome : "—"}</td>
        <td><button class="btn-ver-alunos" onclick="verAlunosTurma('${turma.id}')">Ver Alunos</button></td>
      </tr>
    `;
  });
}

document.getElementById("linkTurmas").addEventListener("click", () => {
  mostrarPagina("turmas");
  carregarTurmasProfessor();
});

function verAlunosTurma(idTurma) {
  localStorage.setItem("turmaSelecionada", idTurma);
  mostrarPagina("lancarNotas"); // Redireciona para a tela onde já lista os alunos
}

</script>
</body>
</html>